### MEXIKHA CBs 1.08

tributary_offmap_mexikha_cb = {
	name = CB_NAME_PERMANENT_TRIBUTARY
	war_name = WAR_NAME_PERMANENT_TRIBUTARY
	sprite = 30
	truce_days = 365
	hostile_against_others = yes
	can_ask_to_join_war = no
	display_on_map = no
	allowed_to_target_tributaries = no
	
	defender_unoccupied_warscore = yes
	
	can_use = {
		ROOT = {
			independent = yes
			NOT = { same_realm = FROM }
			NOT = { is_liege_or_above = FROM }
			mercenary = no
		}
		
		FROM = {
			independent = yes
			in_revolt = no
		}
	}

	is_valid = {
		NOT = {
			ROOT = {
				rightful_religious_head_scope = {
					character = FROM 
				}
			}
		}
	}

	on_success = {
		log = "---------------------"
		log = "Mexikha Logging:"
		log = "The [offmap_mexikha.GetShortName] invasion of [From.GetTitledName] has ended"
		log = "The war ended in a victory for Mexikha"
		log = "[From.GetTitledName] is now tributary of Mexikha"
		log = "---------------------"
		FROM = {
			save_event_target_as = target_loser
			prestige = -100
			custom_tooltip = {
				text = "REMOVE_PREVIOUS_SUZERAIN"
				hidden_tooltip = {
					any_suzerain = {
						event_target:target_loser = {
							remove_tributary = PREV
						}
					}
				}
			}
			if = { # Remove Raid Mexikha if active
				limit = {
					has_character_modifier = mexikha_raid_active
				}
				remove_character_modifier = mexikha_raid_active
				hidden_effect = {
					add_character_modifier = {
						name = mexikha_raid_grace_cd
						hidden = yes
						years = 5
					}
				}
			}
		}

		ROOT = {
			prestige = 200
			make_tributary = { who = FROM tributary_type = offmap }
		}
	}

	on_fail = {
		log = "---------------------"
		log = "Mexikha Logging:"
		log = "The [offmap_mexikha.GetShortName] invasion of [From.GetTitledName] has ended"
		log = "The war ended in a white peace"
		log = "---------------------"
		ROOT = {
			prestige = -200
		}
		FROM = {
			prestige = 200
			set_character_flag = defeated_mexikha
		}
	}

	on_reverse_demand = {
		log = "---------------------"
		log = "Mexikha Logging:"
		log = "The [offmap_mexikha.GetShortName] invasion of [From.GetTitledName] has ended"
		log = "The war ended in a victory for [From.GetTitledName]"
		log = "---------------------"
		ROOT = {
			prestige = -500
			transfer_scaled_wealth = {
				to = FROM
				value = 5.0
				min = 1000
			}
			hidden_effect = {
				if = { #Makes Mexikha have a chance of leaving Expansionist policy...
					limit = {
						is_offmap_tag = offmap_mexikha
						offmap_mexikha = {
							has_policy = mexikha_expansionist
						}
					}
					random = {
						chance = 50
						offmap_mexikha = {
							set_policy = mexikha_open
						}
					}
				}
				log = "Mexikha War Logging: Mexikha lost a I'll-make-you-my-tributary war against [From.GetBestName]"
			}
		}

		FROM = {
			piety = 500
			participation_scaled_prestige = 2500
			set_character_flag = defeated_mexikha
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 1000 }
		}
	}
	
	on_attacker_leader_death = {
		#end_war = invalid
	}

	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 100
	}

	ai_will_do = {
		factor = 0
	}
}

invasion_of_mexikha_cb = {
	name = CB_NAME_INVASION_OF_CHINA
	war_name = WAR_NAME_INVASION_OF_CHINA
	sprite = 30
	truce_days = 365
	hostile_against_others = yes
	can_ask_to_join_war = yes
	allowed_to_target_tributaries = no
	allow_whitepeace = no
	battle_warscore_mult = 1.5
	max_attacker_occupation_score = 50
	max_defender_occupation_score = 50
	max_attacker_battle_score = 100
	capturing_defender_is_complete_victory = no
	third_party_portrait = event_target:invasion_of_china_claimant

	# attacker_unoccupied_warscore = yes - If attacker completely unoccupied, attacker will get ticking warscore. Only works if no title is targetted
	# defender_unoccupied_warscore = yes - If defender completely unoccupied, defender will get ticking warscore. Only works if no title is targetted
	
	can_use = {
		ROOT = {
			independent = yes
			NOT = { same_realm = FROM }
			NOT = { is_liege_or_above = FROM }
			mercenary = no
		}
		FROM = {
			is_offmap_governor = yes
			offmap_power = { is_offmap_tag = offmap_china }
		}
	}

	is_valid = { event_target:invasion_of_china_claimant = { is_alive = yes } }

	on_success = {
		ROOT = {
			show_scope_change = no
			custom_tooltip = {
				text = invasion_of_china_success_tt
				hidden_effect = {
					remove_character_modifier = china_raid_active
					event_target:invasion_of_china_claimant = {
						betrothed = { break_betrothal = PREV }
						spouse = {
							if = {
								limit = {
									is_ruler = no
									is_primary_heir = no
								}
								leave_court_for_china_effect = yes
							}
						}
						any_child = {
							if = {
								limit = {
									is_ruler = no
									is_primary_heir = no
								}
								leave_court_for_china_effect = yes
							}
						}
						abdicate = yes
						any_claim = {
							remove_claim = event_target:invasion_of_china_claimant
						}
						clr_character_flag = no_court_invites
						remove_trait = cannot_marry
						diplomatic_immunity = no
					}
					offmap_china = {
						governor = {
							any_vassal = {
								set_defacto_liege = ROOT
							}
							any_demesne_title = {
								limit = {
									NOT = {
										tier = EMPEROR
									}
								}
								grant_title = ROOT
							}
						}
						ROOT = {
							if = {
								limit = { government = chinese_imperial_government }
								offmap_china = { set_offmap_flag = rename_override }
								primary_title = {
									trigger_switch = {
										on_trigger = has_title_flag
										china_name_Tang = { offmap_china = { set_offmap_name = "tang_china" } }
										china_name_Jin = { offmap_china = { set_offmap_name = "jin_china" } }
										china_name_Wei = { offmap_china = { set_offmap_name = "wei_china" } }
										china_name_Qi = { offmap_china = { set_offmap_name = "qi_china" } }
										china_name_Zhou = { offmap_china = { set_offmap_name = "zhou_china" } }
										china_name_Han = { offmap_china = { set_offmap_name = "han_china" } }
										china_name_Qin = { offmap_china = { set_offmap_name = "qin_china" } }
										china_name_Yan = { offmap_china = { set_offmap_name = "yan_china" } }
										china_name_Zhao = { offmap_china = { set_offmap_name = "zhao_china" } }
										china_name_Liao = { offmap_china = { set_offmap_name = "liao_china" } }
										china_name_Yuan = { offmap_china = { set_offmap_name = "yuan_china" } }
										china_name_Xia = { offmap_china = { set_offmap_name = "xia_china" } }
										china_name_Qing = { offmap_china = { set_offmap_name = "qing_china" } }
										china_name_Dai = { offmap_china = { set_offmap_name = "dai_china" } }
										china_name_Cheng = { offmap_china = { set_offmap_name = "cheng_china" } }
										china_name_Liang = { offmap_china = { set_offmap_name = "liang_china" } }
										china_name_Song = { offmap_china = { set_offmap_name = "song_china" } }
										china_name_Ming = { offmap_china = { set_offmap_name = "ming_china" } }
										china_name_Shu = { offmap_china = { set_offmap_name = "shu_china" } }
										china_name_Wu = { offmap_china = { set_offmap_name = "wu_china" } }
										china_name_Chu = { offmap_china = { set_offmap_name = "chu_china" } }
										china_name_Yue = { offmap_china = { set_offmap_name = "yue_china" } }
										china_name_Yin = { offmap_china = { set_offmap_name = "yin_china" } }
										china_name_Shun = { offmap_china = { set_offmap_name = "shun_china" } }
									}
									clr_title_flag = pretender_chinese_empire
									clr_title_flag = uses_temple_names_by_script
									clear_flags_with_prefix = temple_name_
									clear_flags_with_prefix = china_name_
									set_name = "[Root.Capital.GetName] Empire"
								}
								clr_character_flag = given_temple_name_by_script
								set_name = ""
								if = {
									limit = {
										religion_group = muslim
									}
									set_government_type = muslim_government
								}
								else_if = {
									limit = {
										culture_group = tibetan_group
										OR = {
											religion = bon
											religion = buddhist
										}
										higher_tier_than = BARON
									}
									set_government_type = theocratic_feudal_government
								}
								else = {
									set_government_type = feudal_government
								}
							}
						}
						set_offmap_flag = no_succession_news
						set_offmap_flag = no_war_news
						clr_offmap_flag = china_invaded_player_dynasty
						set_offmap_flag = china_invaded_player_dynasty
						set_offmap_holder = event_target:invasion_of_china_claimant
						clr_offmap_flag = no_succession_news
						clr_offmap_flag = rename_override
						
						if = {
							limit = {
								NOR = {
									has_status = china_stable
									has_status = china_golden_age
								}
							}
							set_offmap_flag = no_status_news
							set_status = china_stable
							clr_offmap_flag = no_status_news
						}
					}
					any_player = {
						limit = {
							OR = {
								AND = {
									has_offmap_news_enabled = offmap_china
									is_within_diplo_range = FROM
								}
								liege = { character = ROOT }
							}
						}
						narrative_event = { id = JD.60401 }
					}
				}
			}
			participation_scaled_prestige = 5000
			set_offmap_currency = { offmap = offmap_china value = 5000 }
			wealth = 10000
			add_character_modifier = { name = chinese_favored_in_trade inherit = yes years = 50 }
			if = {
				limit = { NOT = { has_artifact = jade_dragon } }
				add_artifact = jade_dragon
			}
			if = {
				limit = { NOT = { has_artifact = chinese_dragon_amulet } }
				add_artifact = chinese_dragon_amulet
			}
			if = {
				limit = { NOT = { has_artifact = water_clock } }
				add_artifact = water_clock
			}
			if = {
				limit = { NOT = { has_artifact = jian_sword } }
				add_artifact = jian_sword
			}
			hidden_effect = { add_character_modifier = { name = peace_deal_with_china inherit = yes years = 50 } }
			remove_character_modifier = china_raid_active
			remove_character_modifier = war_with_china_modifier
		}
		any_attacker = {
			limit = { NOT = { character = ROOT } }
			hidden_tooltip = { participation_scaled_prestige = 2000 }
		}
		clear_global_event_target = invasion_of_china_claimant
	}

	on_invalidation = {
		FROM = {
			piety = 200
			participation_scaled_prestige = 250
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 250 }
		}
		ROOT = {
			prestige = -2500
			remove_character_modifier = war_with_china_modifier
			custom_tooltip = {
				text = invasion_of_china_cb_fail_tt
				hidden_effect = { add_character_modifier = { name = failed_invasion_of_china duration = -1 hidden = yes } }
			}
			hidden_effect = {
				offmap_china = { set_offmap_flag = no_war_news }
				any_player = {
					limit = {
						OR = {
							AND = {
								has_offmap_news_enabled = offmap_china
								is_within_diplo_range = FROM
							}
							liege = { character = ROOT }
						}
					}
					narrative_event = { id = JD.60403 }
				}
			}
			custom_tooltip = {
				text = angered_china_tt #Scripter! Update this is you change the value below.
				add_character_modifier = {
					modifier = angered_china_modifier
					inherit = yes
					years = 50
				}
			}
		}
		clear_global_event_target = invasion_of_china_claimant
	}

	on_reverse_demand = {
		ROOT = {
			prestige = -3000
			transfer_scaled_wealth = {
				to = FROM
				value = 5.0
				min = 5000
			}
			remove_character_modifier = war_with_china_modifier
			custom_tooltip = {
				text = invasion_of_china_cb_fail_tt
				hidden_effect = { add_character_modifier = { name = failed_invasion_of_china duration = -1 hidden = yes } }
			}
			custom_tooltip = {
				text = destabilization_china_success_tt
				hidden_effect = { 
					offmap_china = { set_offmap_flag = no_war_news }
					any_player = {
						limit = {
							OR = {
								AND = {
									has_offmap_news_enabled = offmap_china
									is_within_diplo_range = FROM
								}
								liege = { character = ROOT }
							}
						}
						narrative_event = { id = JD.60402 }
					}
					any_demesne_title = {
						limit = {
							higher_tier_than = DUKE
							NOR = {
								controls_religion = yes
								clan = yes
							}
						}
						destroy_landed_title = THIS
					}
				}
			}
			custom_tooltip = {
				text = angered_china_tt #Scripter! Update this is you change the value below.
				add_character_modifier = {
					modifier = angered_china_modifier
					inherit = yes
					years = 50
				}
			}
		}
		FROM = {
			piety = 200
			participation_scaled_prestige = 1000
		}
		any_defender = {
			limit = { NOT = { character = FROM } }
			hidden_tooltip = { participation_scaled_prestige = 1000 }
		}
		clear_global_event_target = invasion_of_china_claimant
	}
	
	on_attacker_leader_death = {
		#end_war = invalid
	}

	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 100
	}

	ai_will_do = {
		factor = 0
	}
}