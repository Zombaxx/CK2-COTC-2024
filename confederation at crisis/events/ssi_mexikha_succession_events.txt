namespace = SSI

### Stuff that should probably be handled upon new dynasty for the emperor ###
#- new policy?
#- new status?
#- e_mexikha ruler change?
#- Title (of Mexikha) name change
#- Policy change infrastructure (ended up being another file)
#- Handle tributaries
#- Handle grace values
#- Handle agreements? (Non-agression pacts break)

#TEMPLATE STUFFS/Milla
####Test events for delayed event bouncing
#character_event = { #initial event fired (hidden)
#    id = SSI.10001
#    desc = EVTDESC_SSI_10001
#    picture = GFX_evt_crusaders
#    border = GFX_event_normal_frame_war
#    is_triggered_only = yes
#    offmap = allow #(MUST HAVE)
#
#    trigger = {
#
#    }
#
#    immediate = {
#    	set_character_flag = sent_event_01
#    }
#
#    option = {      
#        name = EVTOPTA_SSI_10001
#        custom_tooltip = { text = EVTOPTA_SSI_10001_TT }
#        character_event = { id = SSI.10002 }
#    }
#}
#
#character_event = { #delayed event that sends actual event to whomever (hidden)
#    id = SSI.10002
#    hide_window = yes
#    is_triggered_only = yes
#    offmap = allow #offmap = allow (MUST HAVE)
#    immediate = {
#    	any_playable_ruler = {
#    		character_event = { id = SSI.10003 } #send a visible event (like NEWS!)
#    	}
#    	set_character_flag = sent_event_02
#    }
#}
#
#character_event = { # Actual important and visible event for player
#    id = SSI.10003
#    desc = EVTDESC_SSI_10005
#	picture = GFX_evt_crusaders
#	border = GFX_event_normal_frame_war
#
#    is_triggered_only = yes
#
#    option = {      
#        name = EVTOPTA_SSI_10001
#        custom_tooltip = { text = EVTOPTA_SSI_10001_TT }
#        set_character_flag = received_event_03
#        #character_event = { id = SSI.10002 days = 15 } #potential follow-up
#    }
#}

# on_offmap_ruler_changed: An offmap power changes its ruler. Triggers for the new ruler
# Root = New ruler
# From = Old ruler
# FromFrom = Offmap

#In case of dynasty change...  (fired from om_action: on_offmap_ruler_changed)
character_event = {
    id = SSI.10005
    hide_window = yes

    has_dlc = "Sunset Invasion"

    is_triggered_only = yes
    offmap = only #alternative would be "offmap = allow" (but that'd *include* them, not be *only* for them)

    trigger = {
        is_offmap_tag = offmap_mexikha
    	NOT = { dynasty = FROM }
    }

    immediate = {
        if = {
            limit = {
                NOT = {
                    any_player = {
                        dynasty = ROOT
                    }
                }
            }
            clr_offmap_flag = mexikha_invaded_player_dynasty
        }

    	#The current mexikha governor form a Government in exile, always.
    	governor = {
			create_title = {
				tier = KING
				landless = no
				temporary = no
				name = "NM_IN_EXILE_KINGDOM"
				holder = THIS
				culture = THIS
				custom_created = yes
			}
			# law setup?
			create_random_soldier = {
				religion = ROOT
				culture = ROOT
				female = no
			}
			new_character = {
				e_mexikha = {
					grant_title_no_opinion = PREV
				}
				any_vassal = {
					set_defacto_liege = PREVPREV
				}
				any_courtier = {
					move_character = PREVPREV
				}
				FROM = {
					move_character = PREVPREV
				}
				character_event = { id = SSI.80 }
			}
			set_defacto_liege = THIS
			set_government_type = theocracy_government
			#Handle tributaries...
            any_tributary = {
                limit = { is_tributary = { type = offmap } }
                remove_tributary = PREV
                set_character_flag = was_tributary_of_mexikha #for new dynasty notification event
            }
			# Should give him a buff modifier
			add_character_modifier = {
				name = mexikhan_swear_strike_back_at_mainland
				years = -1
			}
			# AI obj cleanup
			cancel_ambition = yes
		}

    	#Pick a new state (Emperor dynasty) name...
    	if = {
    		limit = { NOT = { has_offmap_flag = rename_override } }
			random_list = {
	    		#All cultures...
				#Classic stage														# EU4 Tags
				300 = {
		    		trigger = { NOT = { has_offmap_name = "teotihuacan_mexikha" } }
					modifier = {
						factor = 0
						year = 700
					}
	    			set_offmap_name = "teotihuacan_mexikha"							# N/A
					#e_mexikha = { set_name = "teotihuacan_mexikha_full" reset_coa = THIS } 
	    		}
	    		300 = {
	    			trigger = { NOT = { has_offmap_name = "toltec_mexikha" } }
	    			modifier = {
						factor = 0
						year = 900
					}
	    			set_offmap_name = "toltec_mexikha"					 			# N/A
					#e_mexikha = { set_name = "toltec_mexikha_full" reset_coa = THIS } 
	    		}
				#Post-Classic stage													# EU4 Tags
				300 = { #more likely, in general
	    			trigger = { NOT = { has_offmap_name = "aztec_mexikha" } }
					modifier = {
						factor = 0
						NOT = { year = 1428 }
					}
	    			set_offmap_name = "aztec_mexikha"								# AZT, Nahuatl: Aztecatl
					#e_mexikha = { set_name = "aztec_mexikha_full" reset_coa = THIS } 
	    		}
	    		20 = {
	    			trigger = { NOT = { has_offmap_name = "mixotlan_mexikha" } }
	    			set_offmap_name = "mixotlan_mexikha"							# MIX, Nahuatl: Mixtecah
					#e_mexikha = { set_name = "mixotlan_mexikha_full" reset_coa = THIS } 
	    		}
	    		20 = { #more likely, in general
	    			trigger = { NOT = { has_offmap_name = "zapatatec_mexikha" } }
	    			set_offmap_name = "zapatatec_mexikha"							# ZAP, Nahuatl: Tzapotecatl/ Spainish: Zapotec
					#e_mexikha = { set_name = "zapatatec_mexikha_full" reset_coa = THIS } 
	    		}
				30 = { #more likely, in general
	    			trigger = { NOT = { has_offmap_name = "tlaxcala_mexikha" } }
	    			set_offmap_name = "tlaxcala_mexikha"							# TLX
					#e_mexikha = { set_name = "tlaxcala_mexikha_full" reset_coa = THIS } 
	    		}
	    		30 = {
	    			trigger = { NOT = { has_offmap_name = "tlapanec_mexikha" } }
	    			set_offmap_name = "tlapanec_mexikha"							# TLA
					#e_mexikha = { set_name = "tlapanec_mexikha_full" reset_coa = THIS } 
	    		}
				20 = { #more likely, in general
	    			trigger = { NOT = { has_offmap_name = "coixtlahuaca_mexikha" } }
	    			set_offmap_name = "coixtlahuaca_mexikha"						# COI
					#e_mexikha = { set_name = "coixtlahuaca_mexikha_full" reset_coa = THIS } 
	    		}
				#Foreign cultures...
	    		20 = {
	    			trigger = {
	    				NOT = { has_offmap_name = "viking_mexikha" }
	    				race = norse
	    			}
	    			modifier = { #more likely if norse
						factor = 10000
						race = norse
					}
					modifier = { #more likely if norse
						factor = 0
						NOT = { race = norse }
					}
	    			set_offmap_name = "viking_mexikha"								# N/A, Vínland/Vinðland
					#e_mexikha = { set_name = "viking_mexikha_full" reset_coa = THIS } 
	    		}
				20 = {
	    			trigger = {
	    				NOT = { has_offmap_name = "denmark_mexikha" }
	    				religion = zoroastrian
	    			}
	    			modifier = { #more likely if Hindu
						factor = 10000
						religion = zoroastrian
					}
					modifier = {
						factor = 0
						NOT = { religion = zoroastrian }
					}
	    			set_offmap_name = "denmark_mexikha"								# Secret Denmark
					#e_mexikha = { set_name = "denmark_mexikha_full" reset_coa = THIS } 
	    		}
				20 = {
	    			trigger = {
	    				NOT = { has_offmap_name = "yin_china" }
	    				culture = han
	    			}
	    			modifier = { #more likely if Taoist
						factor = 10000
						religion = taoist
					}
					modifier = {
						factor = 0
						NOT = { religion = taoist }
					}
	    			set_offmap_name = "yin_china"									# N/A, Yingzhou
					#e_mexikha = { set_name = "yin_mexikha_full" reset_coa = THIS } 
	    		}
	    		20 = {
	    			trigger = {
	    				NOT = { has_offmap_name = "obsidian_mexikha" }
	    				culture = han
	    			}
	    			modifier = { #more likely if Inti
						factor = 10000
						religion = zun_pagan
					}
					modifier = {
						factor = 0
						NOT = { religion = zun_pagan }
					}
	    			set_offmap_name = "obsidian_mexikha"							# Obsidian Empire
					#e_mexikha = { set_name = "obsidian_mexikha_full" reset_coa = THIS } 
	    		}
	    		20 = {
	    			trigger = {
	    				NOT = { has_offmap_name = "lemuria_mexikha" }
	    				religion = hindu
	    			}
	    			modifier = { #more likely if Hindu
						factor = 10000
						religion = hindu
					}
					modifier = {
						factor = 0
						NOT = { religion = hindu }
					}
	    			set_offmap_name = "lemuria_mexikha"								# Kumarinadu
					#e_mexikha = { set_name = "lemuria_mexikha_full" reset_coa = THIS } 
	    		}
	    		#Mesoamerica culture... (Picked with a lot less frequency than the above ones)
				10 = { #less likely, in general
	    			trigger = { NOT = { has_offmap_name = "huastec_mexikha" } }
	    			set_offmap_name = "huastec_mexikha"								# HST
					#e_mexikha = { set_name = "huastec_mexikha_full" reset_coa = THIS } 
	    		}
				10 = { #less likely, in general
	    			trigger = { NOT = { has_offmap_name = "tarascan_mexikha" } }
	    			set_offmap_name = "tarascan_mexikha" 							# TAR, Nahuatl: Michoacán
					#e_mexikha = { set_name = "tarascan_mexikha_full" reset_coa = THIS } 
	    		}
	    		5 = { #less likely, in general
	    			trigger = { NOT = { has_offmap_name = "teotitlan_mexikha" } }
	    			set_offmap_name = "teotitlan_mexikha"							# TEO
					#e_mexikha = { set_name = "teotitlan_mexikha_full" reset_coa = THIS } 
	    		}
	    		10 = {  #more likely within the category of Nahuatl, but less likely in general
		    		trigger = { NOT = { has_offmap_name = "totonac_mexikha" } }
	    			set_offmap_name = "totonac_mexikha"								# TOT
					#e_mexikha = { set_name = "totonac_mexikha_full" reset_coa = THIS } 
	    		}
	    		5 = { #less likely, in general
	    			trigger = { NOT = { has_offmap_name = "itza_mexikha" } }
	    			set_offmap_name = "itza_mexikha"								# ITZ
					#e_mexikha = { set_name = "itza_mexikha_full" reset_coa = THIS } 
	    		}
	    		5 = { #less likely, in general
	    			trigger = { NOT = { has_offmap_name = "guamar_mexikha" } }
	    			set_offmap_name = "guamar_mexikha"								# GAM
					#e_mexikha = { set_name = "guamar_mexikha_full" reset_coa = THIS } 
	    		}
	    		5 = { #less likely, in general
	    			trigger = { NOT = { has_offmap_name = "otomi_mexikha" } }
	    			set_offmap_name = "otomi_mexikha"								# OTO
					#e_mexikha = { set_name = "otomi_mexikha_full" reset_coa = THIS } 
	    		}
	    		5 = { #less likely, in general
	    			trigger = { NOT = { has_offmap_name = "colima_mexikha" } }
	    			set_offmap_name = "colima_mexikha"								# CLM
					#e_mexikha = { set_name = "colima_mexikha_full" reset_coa = THIS } 
	    		}
	    		5 = { #less likely, in general
	    			trigger = { NOT = { has_offmap_name = "tonala_mexikha" } }
		  			set_offmap_name = "tonala_mexikha"								# TON
					#e_mexikha = { set_name = "tonala_mexikha_full" reset_coa = THIS } 
	    		}
	    		3 = { #even less likely, in general
	    			trigger = { NOT = { has_offmap_name = "xalisco_mexikha" } }
	    			set_offmap_name = "xalisco_mexikha"								# XAL
					#e_mexikha = { set_name = "xalisco_mexikha_full" reset_coa = THIS } 
	    		}
	    		3 = { #even less likely, in general
	    			trigger = { NOT = { has_offmap_name = "kiche_mexikha" } }
	    			set_offmap_name = "kiche_mexikha"								# KIC
					#e_mexikha = { set_name = "kiche_mexikha_full" reset_coa = THIS } 
	    		}
	    		3 = { #even less likely, in general
	    			trigger = { NOT = { has_offmap_name = "chichimeca_mexikha" } }
	    			set_offmap_name = "chichimeca_mexikha"							# CCM
					#e_mexikha = { set_name = "chichimeca_mexikha_full" reset_coa = THIS } 
	    		}
	    	}
		}

        #Break peace deal
        any_playable_ruler = {
            limit = {
				has_character_modifier = peace_deal_with_mexikha
				OR = {
					ai = yes
					NOT = { has_offmap_news_enabled = FROMFROM }
					NOT = { is_within_diplo_range = ROOT }
				}
			}
            remove_character_modifier = peace_deal_with_mexikha
        }

        #Reset Cooldowns
        any_playable_ruler = {
            limit = {
                OR = {
                    has_character_modifier = mexikhan_grace_send_gift_timer
                    has_character_modifier = mexikhan_grace_send_eunuch_timer
                    has_character_modifier = mexikhan_grace_send_concubine_timer
                    has_character_modifier = mexikhan_grace_tributary_timer
                    has_character_modifier = ssi_mexikha_boon_cd
                    has_character_modifier = mexikha_force_open_cooldown
                    has_character_modifier = angered_mexikha_modifier
                    has_character_modifier = mexikhan_imperial_trade_contract
					has_character_modifier = mexikha_raid_grace_cd
                }
            }
            remove_character_modifier = mexikhan_grace_send_gift_timer
            remove_character_modifier = mexikhan_grace_send_eunuch_timer
            remove_character_modifier = mexikhan_grace_send_concubine_timer
            remove_character_modifier = mexikhan_grace_tributary_timer
            remove_character_modifier = ssi_mexikha_boon_cd
            remove_character_modifier = mexikha_force_open_cooldown
            remove_character_modifier = angered_mexikha_modifier
            remove_character_modifier = mexikhan_imperial_trade_contract
			remove_character_modifier = mexikha_raid_grace_cd
        }
    }
}

# on_startup event for dealing with e_mexikha not having a proper name for the Mexikhan Empire... 
character_event = {
    id = SSI.10006
    is_triggered_only = yes

    hide_window = yes
	
	trigger = {
        ai = no
        offmap_mexikha = {
            has_offmap_name = mexikha_mexikha
        }
    }

    immediate = {
        offmap_mexikha = {
			set_policy = mexikha_isolationist
			log = "-------------------------------------"
			log = "Mexikha Policy Logging:"
			log = "Mexikhas new Policy is now ISOLATIONIST"
			log = "-------------------------------------"
			clr_offmap_flag = mexikha_isolationist_trend
            governor = {
				set_government_type = order_government
			}
			set_government_type = theocracy_government
			random_list = {
                10 = {  #pretty likely
                    set_offmap_name = "chichimeca_mexikha"
                }
                5 = { #less likely
                    set_offmap_name = "toltec_mexikha"
                }
                5 = { #less likely
                    modifier = { #even less likely to be picked early game
                        factor = 0.1
                        NOT = { year = 1200 }
                    }
                    set_offmap_name = "aztec_mexikha"
                }
                5 = { #less likely
                    set_offmap_name = "itza_mexikha"
                }
                5 = { #less likely
                    set_offmap_name = "zapatatec_mexikha"
                }
                5 = { #less likely
                    set_offmap_name = "mixotlan_mexikha"
                }
                5 = { #less likely
                    set_offmap_name = "huastec_mexikha"
                }
                3 = { #even less likely
                    set_offmap_name = "kiche_mexikha"
                }
                3 = { #even less likely
                    set_offmap_name = "teotihuacan_mexikha"
                }
                3 = { #even less likely
                    modifier = { #less likely to be picked early game
                        factor = 0.1
                        NOT = { year = 1200 }
                    }
                    set_offmap_name = "tarascan_mexikha"
                }
            }
        }
    }
}

character_event = {
	id = SSI.31000
	hide_window = yes
	
	is_triggered_only = yes
	offmap = only
	
	immediate = {
		if = {
			limit = {
				FROMFROM = {
					is_offmap_tag = offmap_mexikha
				}
			}
            log = "-------------------------------------"
            log = "Mexikha Logging:"
			log = "Mexikhan succession - New Culture: [Root.Culture.GetName]"
			log = "Mexikhan succession - Old Culture: [From.Culture.GetName]"
			log = "Mexikhan succession - New Religion: [Root.Religion.GetName]"
			log = "Mexikhan succession - Old Religion: [From.Religion.GetName]"
			log = "Mexikhan succession - New Dynasty: [Root.GetOnlyDynastyName]"
			log = "Mexikhan succession - Old Dynasty: [From.GetOnlyDynastyName]"
            log = "-------------------------------------"
		}
#		if = {
#			limit = {
#				is_female = yes
#			}
#			change_variable = {
#				which = global_mexikha_amount_of_female_rulers
#				value = 1
#			}
#		}
#		if = {
#			limit = {
#				NOT = { is_female = yes }
#			}
#			change_variable = {
#				which = global_mexikha_amount_of_male_rulers
#				value = 1
#			}
#		}
#		if = {
#			limit = {
#				NOT = { dynasty = FROM }
#			}
#			change_variable = {
#				which = global_mexikha_amount_of_dynastic_changes
#				value = 1
#			}
#		}
#		if = {
#			limit = {
#				culture = nahuatl
#				NOT = { culture = FROM }
#			}
#			change_variable = {
#				which = global_mexikha_amount_of_culture_swaps_to_han
#				value = 1
#			}
#		}
#		if = {
#			limit = {
#				culture = jurchen
#				NOT = { culture = FROM }
#			}
#			change_variable = {
#				which = global_mexikha_amount_of_culture_swaps_to_jurchen
#				value = 1
#			}
#		}
#		if = {
#			limit = {
#				culture = norse
#				NOT = { culture = FROM }
#			}
#			change_variable = {
#				which = global_mexikha_amount_of_culture_swaps_to_norse
#				value = 1
#			}
#		}
#		if = {
#			limit = {
#				culture = khitan
#				NOT = { culture = FROM }
#			}
#			change_variable = {
#				which = global_mexikha_amount_of_culture_swaps_to_khitan
#				value = 1
#			}
#		}
#		if = {
#			limit = {
#				culture = uyghur
#				NOT = { culture = FROM }
#			}
#			change_variable = {
#				which = global_mexikha_amount_of_culture_swaps_to_uyghur
#				value = 1
#			}
#		}
#		if = {
#			limit = {
#				culture = kirghiz
#				NOT = { culture = FROM }
#			}
#			change_variable = {
#				which = global_mexikha_amount_of_culture_swaps_to_kirghiz
#				value = 1
#			}
#		}
#		if = {
#			limit = {
#				NOR = {
#					culture = nahuatl
#					culture = jurchen
#					culture = norse
#					culture = khitan
#					culture = uyghur
#					culture = kirghiz
#				}
#				NOT = { culture = FROM }
#			}
#			change_variable = {
#				which = global_mexikha_amount_of_culture_swaps_to_something_else
#				value = 1
#			}
#		}
#		if = {
#			limit = {
#				religion = taoist
#				NOT = { religion = FROM }
#			}
#			change_variable = {
#				which = global_mexikha_amount_of_religion_swaps_to_taoist
#				value = 1
#			}
#		}
#		if = {
#			limit = {
#				religion = tengri_pagan
#				NOT = { religion = FROM }
#			}
#			change_variable = {
#				which = global_mexikha_amount_of_religion_swaps_to_tengri
#				value = 1
#			}
#		}
#		if = {
#			limit = {
#				NOR = {
#					religion = taoist
#					religion = tengri_pagan
#				}
#				NOT = { culture = FROM }
#			}
#			change_variable = {
#				which = global_mexikha_amount_of_religion_swaps_to_something_else
#				value = 1
#			}
#		}
	}
}